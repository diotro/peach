const path = require('path');
const fs = require('fs');
const camelCase = require('camelcase');

const headerTemplate = `
/*
 * This file is automatically generated from 'yarn generate-types'
 * via the codegen-index-plugin.js
 *
 * do not edit this file manually!
 */

`;

const getFiles = directory => {
  const normalizedDirectory = path.normalize(directory);
  const files = fs
    .readdirSync(normalizedDirectory)
    .map(file => normalizedDirectory + path.sep + file);

  return files.flatMap(file => {
    if (fs.statSync(file).isDirectory()) {
      return getFiles(file);
    }
    if (file.endsWith('.ts') && !file.endsWith('index.ts')) {
      return file;
    }
    return [];
  });
};

const importName = file => camelCase(path.basename(file).split('.')[0]);

const importPath = (fileBase, file) => {
  const base = path.join(__dirname, fileBase);
  return `./${path.relative(base, file).replace(path.extname(file), '')}`;
};

const importAll = (files, outputFilePath, exportName) => {
  const imports = files.flatMap(
    file =>
      `import {${exportName} as ${importName(file)}} from '${importPath(outputFilePath, file)}';\n`
  );

  return `${imports.join('')}\n`;
};

const exportAll = (files, exportName) => `export const ${exportName}s = [
    ${files.flatMap(file => importName(file))}
  ]
  `;

module.exports = {
  plugin: (_schema, _documents, config, info) => {
    const outputFilePath = path.dirname(info.outputFile);
    const files = getFiles(path.join(__dirname, outputFilePath));

    return (
      headerTemplate +
      importAll(files, outputFilePath, config.exportName) +
      exportAll(files, config.exportName)
    );
  }
};
